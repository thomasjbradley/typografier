var hash=window.location.hash.replace(/#/,""),hashBits,previewWin,sizes=[{sel:[".yotta"],power:7},{sel:[".zetta"],power:6},{sel:["h1",".exa"],power:5},{sel:["h2",".peta"],power:4},{sel:["h3",".tera"],power:3},{sel:["h4",".giga"],power:2},{sel:["h5",".mega"],power:1},{sel:["h6",".kilo","input","textarea"],power:0},{sel:["small",".milli"],power:-1},{sel:[".micro"],power:-2}],originalFontSize=16,superDefaults=[[0,100,1.3,1.067,0],[38,110,1.4,1.125,1],[60,120,1.5,1.125,1],[90,130,1.5,1.125,1]],defaults=superDefaults,breakpointCount=0,$breakpoints=$("#breakpoints"),$btnAdd=$("#btn-add-breakpoint"),$controls=$("#controls"),$cssOutput=$("#output"),$legacy=$("#legacy"),view=function(a,b){return b||(b={}),b.legacy=$legacy.is(":checked"),prepareTemplate(a,b)},convertToPx=function(a){return Math.round(a*originalFontSize)},calculateLineHeight=function(a,b,c){for(var d=1.9,e=1.3,f=a/c,g=parseFloat(a)/4,h=parseFloat(a);e>f;)h+=g,f=h/c;for(;f>d;)h-=g,f=h/c;return h};calculateValues=function(a,b,c,d){var e=a/100*Math.pow(c,d),f=calculateLineHeight(b,d,e);return{fontSize:e,lineHeight:f}},typeScales=function(a,b,c,d,e){var f=[],g="";return sizes.forEach(function(d,e,g){var h=calculateValues(a,b,c,sizes[e].power),i=sizes[e].sel;f.push(view("css-element",{selectors:i.join(", "),"font-size":h.fontSize.toFixed(4),"font-size-px":convertToPx(h.fontSize),"line-height":h.lineHeight.toFixed(4),"line-height-px":convertToPx(h.lineHeight)}))}),g=view(e,{"base-line-height":b,"base-line-height-px":convertToPx(b),"line-height-half":(b/2).toFixed(4),"line-height-half-px":convertToPx(Math.round(b/2)),"line-height-quarter":(b/4).toFixed(4),"line-height-quarter-px":convertToPx(Math.round(b/4)),"line-height-double":(2*b).toFixed(4),"line-height-double-px":convertToPx(2*b),"type-scale":f.join(""),"hang-punc":d,"not-hang-punc":!d})},addNewBreakpoint=function(){var a=20,b=[];b=defaults[breakpointCount]?defaults[breakpointCount]:[parseInt(defaults[defaults.length-1][0],10)+(breakpointCount-(defaults.length-1))*a,defaults[defaults.length-1][1],defaults[defaults.length-1][2],defaults[defaults.length-1][3],defaults[defaults.length-1][4]],$breakpoints.append(view("breakpoint",{id:breakpointCount,"min-width":b[0],"font-size":b[1],"line-height":b[2],"hang-punc":b[4]?"checked":""})),$breakpoints.find("tr:last-child .type-scale").val(b[3]),breakpointCount++},buildOutput=function(){var a,b,c=[],d="",e=[];$breakpoints.children().each(function(){var d=$.trim($(this).find(".font-size").val()),f=$.trim($(this).find(".line-height").val()),g=$.trim($(this).find(".type-scale").val()),h=$(this).find(".min-width"),i=$.trim(h.val()),j=parseInt(i,10)>0,k=$(this).find(".hang-punc").is(":checked");j?(e.push([i,d,f,g,k?1:0]),c.push(view("media-query",{"min-width":i,"font-size":d,"line-height":f,css:typeScales(100,f,g,k,"scale-base")}))):(a=d,b=f,e.push([0,d,f,g,k?1:0]),c=c.concat(typeScales(d,f,g,k,"scale-base")))}),d=[view("css-base",{build:window.location.protocol+"//"+window.location.host+window.location.pathname+"#"+e.join(";"),"base-font":defaults[0][1],"base-line-height":defaults[0][2],main:c.join("")})],$cssOutput.text(d),window.location.hash=e.join(";"),previewWin&&(previewWin.location=window.location.href.replace("#","preview/#"),previewWin.location.reload())},$controls.on("keyup change submit",function(a){a.preventDefault(),buildOutput()}),$btnAdd.on("click",function(){addNewBreakpoint(),buildOutput()}),$controls.on("click",".btn-remove-breakpoint",function(a){a.preventDefault(),$(this).parent().parent().remove(),breakpointCount--,buildOutput()}),hash&&(hashBits=hash.split(";"),defaults=[],hashBits.forEach(function(a){var b=a.split(",");b[4]="1"===b[4]?!0:!1,defaults.push(b)})),defaults.forEach(function(){addNewBreakpoint(),buildOutput()}),$breakpoints.find(".breakpoint:first-child .breakpoint-em").html('<span class="infinite">âˆž</span>'),$breakpoints.find(".breakpoint:first-child .btn-remove-breakpoint").remove(),$("#preview").on("click",function(a){a.preventDefault(),previewWin=window.open("/preview/"+window.location.hash,"preview")});